#!/usr/bin/env bash
#
# pt - Process Triage Wrapper
#
# This script wraps the 'pt-core' Alien Technology Artifact.
# It ensures the environment is set up correctly and forwards all arguments.
#
set -euo pipefail

readonly VERSION="2.0.3"

# ══════════════════════════════════════════════════════════════════════════════
# Configuration
# ══════════════════════════════════════════════════════════════════════════════

readonly PT_CORE_BIN="pt-core"
readonly INSTALL_BASE_URL="https://raw.githubusercontent.com/Dicklesworthstone/process_triage"
readonly INSTALL_URL="${INSTALL_BASE_URL}/master/install.sh"
readonly PINNED_INSTALL_URL="${INSTALL_BASE_URL}/v${VERSION}/install.sh"

# Locations to search for pt-core
readonly SEARCH_PATHS=(
    "$(dirname "$0")/pt-core"
    "$(dirname "$0")/target/release/pt-core"
    "$HOME/.local/bin/pt-core"
    "/usr/local/bin/pt-core"
    "/usr/bin/pt-core"
)

# ══════════════════════════════════════════════════════════════════════════════
# Discovery
# ══════════════════════════════════════════════════════════════════════════════

find_pt_core() {
    # Check explicit override
    if [[ -n "${PT_CORE_PATH:-}" ]]; then
        if [[ -x "$PT_CORE_PATH" ]]; then
            echo "$PT_CORE_PATH"
            return 0
        fi
    fi

    # Check search paths
    for path in "${SEARCH_PATHS[@]}"; do
        if [[ -x "$path" ]]; then
            echo "$path"
            return 0
        fi
    done

    # Check PATH
    if command -v "$PT_CORE_BIN" &>/dev/null; then
        command -v "$PT_CORE_BIN"
        return 0
    fi

    return 1
}

# ══════════════════════════════════════════════════════════════════════════════
# UI mode selection
# ══════════════════════════════════════════════════════════════════════════════

detect_auto_ui_mode() {
    if [[ ! -t 0 || ! -t 1 ]]; then
        printf 'shell\n'
        return 0
    fi

    if [[ "${CI:-}" == "true" || "${CI:-}" == "1" ]]; then
        printf 'shell\n'
        return 0
    fi

    if [[ "${TERM:-}" == "dumb" ]]; then
        printf 'shell\n'
        return 0
    fi

    printf 'tui\n'
}

resolve_ui_mode() {
    local cli_mode="${1:-}"
    local env_mode="${PT_UI_MODE:-auto}"

    if [[ "$cli_mode" == "shell" || "$cli_mode" == "tui" ]]; then
        printf '%s\n' "$cli_mode"
        return 0
    fi

    case "$env_mode" in
        shell|tui)
            printf '%s\n' "$env_mode"
            return 0
            ;;
        auto|"")
            ;;
        *)
            ;;
    esac

    detect_auto_ui_mode
}

# ══════════════════════════════════════════════════════════════════════════════
# Main
# ══════════════════════════════════════════════════════════════════════════════

main() {
    local cli_mode=""
    local -a forwarded_args=()
    local arg

    for arg in "$@"; do
        case "$arg" in
            --shell)
                if [[ "$cli_mode" == "tui" ]]; then
                    echo "Error: --shell and --tui cannot be used together." >&2
                    exit 2
                fi
                cli_mode="shell"
                ;;
            --tui)
                if [[ "$cli_mode" == "shell" ]]; then
                    echo "Error: --shell and --tui cannot be used together." >&2
                    exit 2
                fi
                cli_mode="tui"
                ;;
            *)
                forwarded_args+=("$arg")
                ;;
        esac
    done

    local selected_ui_mode
    selected_ui_mode="$(resolve_ui_mode "$cli_mode")"
    export PT_UI_MODE="$selected_ui_mode"

    local pt_core
    pt_core=$(find_pt_core) || {
        echo "Error: 'pt-core' binary not found." >&2
        echo "Please install it via:" >&2
        echo "  curl -fsSL $INSTALL_URL | bash" >&2
        echo "  # or" >&2
        echo "  wget -qO- $INSTALL_URL | bash" >&2
        exit 1
    }

    # Special handling for 'update' (wrapper-level)
    if [[ "${forwarded_args[0]:-}" == "update" ]]; then
        echo "Updating Process Triage..."
        local update_installer_cmd
        if command -v curl &>/dev/null; then
            update_installer_cmd="curl -fsSL $PINNED_INSTALL_URL | bash"
        elif command -v wget &>/dev/null; then
            update_installer_cmd="wget -qO- $PINNED_INSTALL_URL | bash"
        else
            update_installer_cmd=""
        fi
        if [[ -z "$update_installer_cmd" ]]; then
            echo "Error: neither curl nor wget is available to run installer." >&2
            exit 1
        fi
        bash -c "set -euo pipefail; $update_installer_cmd"
        exit $?
    fi

    if [[ "${forwarded_args[0]:-}" == "--version" || "${forwarded_args[0]:-}" == "-V" ]]; then
        printf 'pt %s\n' "$VERSION"
        exit 0
    fi

    # Forward to pt-core
    # We use 'exec' to replace the shell process
    exec "$pt_core" "${forwarded_args[@]}"
}

main "$@"
