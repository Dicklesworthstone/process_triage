{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/Dicklesworthstone/process_triage/schemas/capabilities.schema.json",
  "title": "Process Triage Capabilities Manifest",
  "description": "Schema for the capabilities manifest generated by the pt wrapper and consumed by pt-core",
  "type": "object",
  "required": ["manifest_version", "os", "user", "tools", "paths"],
  "additionalProperties": false,
  "properties": {
    "manifest_version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Semantic version of this manifest schema (e.g., '1.0.0')"
    },
    "generated_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO-8601 timestamp when this manifest was generated"
    },
    "os": {
      "type": "object",
      "description": "Operating system information",
      "required": ["family"],
      "additionalProperties": false,
      "properties": {
        "family": {
          "type": "string",
          "enum": ["linux", "darwin", "freebsd", "unknown"],
          "description": "OS family (linux, darwin, freebsd, or unknown)"
        },
        "release": {
          "type": "string",
          "description": "OS release name (e.g., 'Ubuntu 24.04', 'macOS 14.0')"
        },
        "kernel": {
          "type": "string",
          "description": "Kernel version string (e.g., '6.17.0-8-generic')"
        },
        "arch": {
          "type": "string",
          "enum": ["x86_64", "aarch64", "arm64", "i686", "armv7l"],
          "description": "CPU architecture"
        }
      }
    },
    "init_system": {
      "type": "string",
      "enum": ["systemd", "launchd", "openrc", "sysvinit", "unknown"],
      "description": "Init system in use"
    },
    "package_manager": {
      "type": "string",
      "enum": ["apt", "brew", "dnf", "pacman", "apk", "pkg", "none"],
      "description": "Primary package manager available"
    },
    "user": {
      "type": "object",
      "description": "Current user information",
      "required": ["uid", "username", "home"],
      "additionalProperties": false,
      "properties": {
        "uid": {
          "type": "integer",
          "minimum": 0,
          "description": "User ID"
        },
        "username": {
          "type": "string",
          "description": "Username"
        },
        "home": {
          "type": "string",
          "description": "Home directory path"
        },
        "shell": {
          "type": "string",
          "description": "User's login shell path"
        }
      }
    },
    "tools": {
      "type": "object",
      "description": "Map of tool name to availability information",
      "additionalProperties": {
        "type": "object",
        "required": ["available"],
        "properties": {
          "available": {
            "type": "boolean",
            "description": "Whether the tool is available"
          },
          "path": {
            "type": "string",
            "description": "Absolute path to the tool binary (if available)"
          },
          "version": {
            "type": "string",
            "description": "Version string (if available and detectable)"
          },
          "reason": {
            "type": "string",
            "description": "Reason tool is unavailable (if not available)"
          }
        }
      },
      "propertyNames": {
        "enum": [
          "ps", "kill", "bash",
          "jq", "gum",
          "lsof", "ss", "netstat", "pgrep", "who", "w", "git",
          "perf", "bpftrace", "bcc", "strace", "dtruss", "sysdig",
          "iotop", "nethogs", "pidstat", "iostat", "mpstat", "sar",
          "smem", "nvidia-smi", "rocm-smi"
        ]
      }
    },
    "privileges": {
      "type": "object",
      "description": "Privilege and capability information",
      "additionalProperties": false,
      "properties": {
        "can_sudo": {
          "type": "boolean",
          "description": "Whether non-interactive sudo is available (sudo -n)"
        },
        "perf_paranoid": {
          "type": "integer",
          "minimum": -1,
          "maximum": 4,
          "description": "Value of /proc/sys/kernel/perf_event_paranoid (-1 to 4)"
        },
        "ptrace_scope": {
          "type": "integer",
          "minimum": 0,
          "maximum": 3,
          "description": "Value of /proc/sys/kernel/yama/ptrace_scope (0-3)"
        }
      }
    },
    "paths": {
      "type": "object",
      "description": "Standard paths used by process_triage",
      "required": ["config_dir", "data_dir"],
      "additionalProperties": false,
      "properties": {
        "config_dir": {
          "type": "string",
          "description": "Configuration directory (e.g., ~/.config/process_triage)"
        },
        "data_dir": {
          "type": "string",
          "description": "Data directory (e.g., ~/.local/share/process_triage)"
        },
        "telemetry_dir": {
          "type": "string",
          "description": "Telemetry storage directory"
        },
        "lock_file": {
          "type": "string",
          "description": "Path to the coordination lock file"
        }
      }
    },
    "system": {
      "type": "object",
      "description": "System resource information",
      "additionalProperties": false,
      "properties": {
        "cpu_count": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of logical CPUs"
        },
        "memory_total_bytes": {
          "type": "integer",
          "minimum": 0,
          "description": "Total system memory in bytes"
        },
        "clk_tck": {
          "type": "integer",
          "minimum": 1,
          "description": "Clock ticks per second (sysconf(_SC_CLK_TCK))"
        },
        "boot_id": {
          "type": "string",
          "description": "Unique boot identifier from /proc/sys/kernel/random/boot_id"
        }
      }
    }
  }
}
